@page "{id}"
@using Hubletix.Core.Constants
@model PlanDetailModel
@{
    ViewData["Title"] = "Edit Membership Plan";
    ViewData["TenantName"] = Model.CurrentTenantInfo.Name;
    Layout = "_AdminLayout";
}

<div class="container-fluid py-4">

    @if (Model.Plan == null)
    {
        <div class="row mb-4">
            <div class="col-12">
                <a href="/admin/plans" class="btn btn-sm btn-outline-secondary mb-3">
                    <i class="bi bi-arrow-left"></i> View All Plans
                </a>
                <h1 class="display-5 fw-bold">Uh-Oh!</h1>
                <p class="text-muted">Sorry, that membership plan was not found.</p>
            </div>
        </div>
    }
    else
    {
        <div class="row mb-4">
            <div class="col-12">
                <a href="/admin/plans" class="btn btn-sm btn-outline-secondary mb-3">
                    <i class="bi bi-arrow-left"></i> View All Plans
                </a>
                <h1 class="display-5 fw-bold">@Model.Plan.Name</h1>
                @if (!string.IsNullOrWhiteSpace(Model.Plan.CreatedBy))
                {
                    <p class="text-muted">Created by @Model.Plan.CreatedBy</p>
                }
            </div>
        </div>

        @if (!string.IsNullOrEmpty(Model.StatusMessage))
        {
            <div class="alert alert-info alert-dismissible fade show" role="alert">
                @Model.StatusMessage
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        }

        @if (!string.IsNullOrEmpty(Model.ErrorMessage))
        {
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                @Model.ErrorMessage
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        }

        <div class="row">
            <div class="col-12 col-lg-8">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white border-bottom">
                        <h5 class="mb-0">Plan Details</h5>
                    </div>
                    <div class="card-body">
                        <form method="post">
                            <input type="hidden" asp-for="Plan.Id" />

                            <div class="mb-3">
                                <label asp-for="Plan.Name" class="form-label">Plan Name</label>
                                <input class="form-control" asp-for="Plan.Name" placeholder="Enter plan name" required />
                                <span asp-validation-for="Plan.Name" class="text-danger small"></span>
                            </div>

                            <div class="mb-3">
                                <label asp-for="Plan.Description" class="form-label">Description</label>
                                <textarea class="form-control" asp-for="Plan.Description" rows="3" placeholder="Enter plan description"></textarea>
                                <span asp-validation-for="Plan.Description" class="text-danger small"></span>
                            </div>

                            <div class="row">
                                <div class="col-12 col-md-6 mb-3">
                                    <label asp-for="PriceInDollars" class="form-label">Price</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" class="form-control" asp-for="PriceInDollars" 
                                               step="0.01" min="0.01" placeholder="0.00" required />
                                    </div>
                                    <span class="text-muted small">Price in dollars</span>
                                </div>

                                <div class="col-12 col-md-6 mb-3">
                                    <label asp-for="Plan.BillingInterval" class="form-label">Billing Interval</label>
                                    <select class="form-select" asp-for="Plan.BillingInterval" asp-items="Model.BillingIntervalOptions" onchange="updateMonthlyDisplayVisibility()"></select>
                                    <span asp-validation-for="Plan.BillingInterval" class="text-danger small"></span>
                                </div>
                            </div>

                            <div class="mb-3" id="monthlyDisplayToggle" style="display: @(Model.Plan.IsRecurring && Model.Plan.BillingInterval != BillingIntervals.Monthly ? "block" : "none")">
                                <label class="form-label">Display price as monthly equivalent?</label>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="IsPriceDisplayedMonthly" asp-for="Plan.IsPriceDisplayedMonthly" onchange="updatePriceDisplayLabel(this)" />
                                    <label class="form-check-label" for="IsPriceDisplayedMonthly" id="priceDisplayLabel">
                                        @(Model.Plan.IsPriceDisplayedMonthly == true ? "Yes" : "No")
                                    </label>
                                </div>
                                <span class="text-muted small">$120/year shows as $10/month</span>
                            </div>

                            <div class="mb-3">
                                <label asp-for="Plan.DisplayOrder" class="form-label">Display Order</label>
                                <input type="number" class="form-control" asp-for="Plan.DisplayOrder" min="0" placeholder="0" />
                                <span class="text-muted small">Lower numbers appear first in listings</span>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Status</label>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="isActive" asp-for="Plan.IsActive" onchange="updateStatusLabel(this)" />
                                    <label class="form-check-label" for="isActive" id="statusLabel">
                                        @(Model.Plan.IsActive == true ? "Active" : "Inactive")
                                    </label>
                                </div>
                            </div>

                            @if (!string.IsNullOrEmpty(Model.Plan.StripeProductId))
                            {
                                <div class="mb-3">
                                    <label class="form-label">Stripe Integration</label>
                                    <div class="bg-light p-3 rounded">
                                        <div class="mb-2">
                                            <small class="text-muted">Product ID:</small><br />
                                            <code class="text-primary">@Model.Plan.StripeProductId</code>
                                        </div>
                                        @if (!string.IsNullOrEmpty(Model.Plan.StripePriceId))
                                        {
                                            <div>
                                                <small class="text-muted">Price ID:</small><br />
                                                <code class="text-primary">@Model.Plan.StripePriceId</code>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }

                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary">Save Changes</button>
                                <a href="/admin/plans" class="btn btn-outline-secondary">Cancel</a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-12 col-lg-4">
                <div class="card border-0 shadow-sm border-danger">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0">Danger Zone</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted small">Once you delete a plan, there is no going back. Please be certain.</p>
                        <button type="button" class="btn btn-outline-danger w-100" data-bs-toggle="modal" data-bs-target="#deleteModal">
                            Delete Plan
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Delete Confirmation Modal -->
        <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header border-danger">
                        <h5 class="modal-title" id="deleteModalLabel">Delete Plan?</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>Are you sure you want to delete <strong>@Model.Plan.Name</strong>?</p>
                        <p class="text-muted small">This action cannot be undone.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <form method="post" asp-page-handler="Delete" style="display: inline;">
                            <input type="hidden" asp-for="Plan.Id" />
                            <button type="submit" class="btn btn-danger">Delete Plan</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // Update plan status label on toggle
            function updateStatusLabel(checkbox) {
                document.getElementById('statusLabel').textContent = checkbox.checked ? 'Active' : 'Inactive';
            }

            // Update plan price display label on toggle
            function updatePriceDisplayLabel(checkbox) {
                document.getElementById('priceDisplayLabel').textContent = checkbox.checked ? 'Yes' : 'No';
            }

            // Show/hide monthly display toggle based on billing interval
            function updateMonthlyDisplayVisibility() {
                const billingInterval = document.getElementById('Plan_BillingInterval').value;
                const monthlyDisplayToggle = document.getElementById('monthlyDisplayToggle');
                
                // Show the toggle only if billing interval is not Monthly
                if (
                  billingInterval !== '@BillingIntervals.Monthly'
                  && billingInterval !== '@BillingIntervals.OneTime'
                ) {
                    monthlyDisplayToggle.style.display = 'block';
                } else {
                    monthlyDisplayToggle.style.display = 'none';
                }
            }
        </script>
    }
</div>
