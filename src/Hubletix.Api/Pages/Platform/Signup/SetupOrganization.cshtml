@page
@model Hubletix.Api.Pages.Platform.Signup.SetupOrganizationModel
@{
    ViewData["Title"] = "Setup Your Organization";
}

<div class="bg-light min-vh-100 py-5">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-12 col-lg-6">
                <!-- Progress Bar -->
                <div class="mb-4">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="small fw-semibold text-primary">Step 2 of 3</span>
                        <span class="small text-muted">Setup Organization</span>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar" role="progressbar" style="width: 66%" aria-valuenow="66" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                </div>

                <div class="card shadow-lg border-0">
                    <div class="card-body p-4 p-md-5">
                        <h1 class="card-title h2 fw-bold mb-2">Setup Your Organization</h1>
                        <p class="text-muted mb-4">Tell us about your organization.</p>

                        @if (!ModelState.IsValid)
                        {
                            <div class="alert alert-danger d-flex align-items-start" role="alert">
                                <i class="bi bi-exclamation-triangle-fill me-2 mt-1"></i>
                                <div>
                                    <strong>Please fix the following errors:</strong>
                                    <ul class="mb-0 mt-2">
                                        @foreach (var error in ModelState.Values.SelectMany(v => v.Errors))
                                        {
                                            <li>@error.ErrorMessage</li>
                                        }
                                    </ul>
                                </div>
                            </div>
                        }

                        <form method="post" asp-page-handler="CreateOrganization">
                            <input type="hidden" asp-for="SessionId" />

                            <div class="mb-3">
                                <label asp-for="OrganizationName" class="form-label fw-semibold">
                                    Organization Name <span class="text-danger">*</span>
                                </label>
                                <input asp-for="OrganizationName" class="form-control form-control-lg" />
                                <span asp-validation-for="OrganizationName" class="text-danger small"></span>
                            </div>

                            <div class="mb-3">
                                <label asp-for="Subdomain" class="form-label fw-semibold">
                                    Subdomain <span class="text-danger">*</span>
                                </label>
                                <div class="input-group input-group-lg">
                                    <input asp-for="Subdomain" class="form-control" />
                                    <span class="input-group-text">.clubmanager.com</span>
                                </div>
                                <div class="form-text">This will be your unique URL (only lowercase letters, numbers, and hyphens)</div>
                                <span asp-validation-for="Subdomain" class="text-danger small"></span>
                            </div>

                            <div class="mb-3">
                                <label asp-for="PhoneNumber" class="form-label fw-semibold">Phone Number</label>
                                <input asp-for="PhoneNumber" type="tel" class="form-control form-control-lg" />
                                <span asp-validation-for="PhoneNumber" class="text-danger small"></span>
                            </div>

                            <div class="mb-3">
                                <label asp-for="Address" class="form-label fw-semibold">Street Address</label>
                                <input asp-for="Address" class="form-control form-control-lg" />
                                <span asp-validation-for="Address" class="text-danger small"></span>
                            </div>

                            <div class="row g-3 mb-3">
                                <div class="col-md-6">
                                    <label asp-for="City" class="form-label fw-semibold">City</label>
                                    <input asp-for="City" class="form-control form-control-lg" />
                                    <span asp-validation-for="City" class="text-danger small"></span>
                                </div>
                                <div class="col-md-6">
                                    <label asp-for="State" class="form-label fw-semibold">State/Province</label>
                                    <input asp-for="State" class="form-control form-control-lg" />
                                    <span asp-validation-for="State" class="text-danger small"></span>
                                </div>
                            </div>

                            <div class="row g-3 mb-4">
                                <div class="col-md-6">
                                    <label asp-for="PostalCode" class="form-label fw-semibold">Postal Code</label>
                                    <input asp-for="PostalCode" class="form-control form-control-lg" />
                                    <span asp-validation-for="PostalCode" class="text-danger small"></span>
                                </div>
                                <div class="col-md-6">
                                    <label asp-for="Country" class="form-label fw-semibold">Country</label>
                                    <input asp-for="Country" class="form-control form-control-lg" />
                                    <span asp-validation-for="Country" class="text-danger small"></span>
                                </div>
                            </div>

                            <div class="d-grid gap-2 d-md-flex">
                                <a href="/signup/CreateAccount?sessionId=@Model.SessionId" class="btn btn-outline-secondary btn-lg flex-fill">
                                    <i class="bi bi-arrow-left me-1"></i> Back
                                </a>
                                <button type="submit" class="btn btn-primary btn-lg flex-fill">
                                    Continue to Payment <i class="bi bi-arrow-right ms-1"></i>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Subdomain validation - allow only lowercase letters, numbers, and hyphens
        document.querySelector('input[name="Subdomain"]')?.addEventListener('input', function(e) {
            // Convert to lowercase and remove invalid characters
            let value = e.target.value.toLowerCase();
            value = value.replace(/[^a-z0-9-]/g, '');
            
            // Don't allow starting or ending with hyphen
            value = value.replace(/^-+|-+$/g, '');
            
            // Don't allow consecutive hyphens
            value = value.replace(/--+/g, '-');
            
            e.target.value = value;
        });
        
        // Real-time subdomain format check
        document.querySelector('input[name="Subdomain"]')?.addEventListener('blur', function(e) {
            const subdomain = e.target.value.trim();
            
            if (subdomain.length > 0 && subdomain.length < 3) {
                alert('Subdomain must be at least 3 characters long.');
                e.target.classList.add('is-invalid');
            } else if (subdomain.length > 63) {
                alert('Subdomain must be 63 characters or less.');
                e.target.classList.add('is-invalid');
            } else {
                e.target.classList.remove('is-invalid');
            }
        });
        
        // Form validation
        document.querySelector('form')?.addEventListener('submit', function(e) {
            const subdomain = document.querySelector('input[name="Subdomain"]').value.trim();
            const orgName = document.querySelector('input[name="OrganizationName"]').value.trim();
            
            if (!orgName) {
                e.preventDefault();
                alert('Organization name is required.');
                return false;
            }
            
            if (!subdomain) {
                e.preventDefault();
                alert('Subdomain is required.');
                return false;
            }
            
            if (subdomain.length < 3) {
                e.preventDefault();
                alert('Subdomain must be at least 3 characters long.');
                return false;
            }
        });
    </script>
}
